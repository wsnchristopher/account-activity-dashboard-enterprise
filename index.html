<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Activity Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 0; }
        .navbar {
            background-color: #333;
            overflow: hidden; /* Keep for now, might remove if causing issues */
            display: flex;
            align-items: center;
            justify-content: space-between; /* Ensures nav-links is centered between brand and spacer */
        }
        .navbar-brand {
            /* float: left; -- Removed as parent is flex */
            display: block;
            color: white;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 1.2em; /* Slightly larger text for brand */
        }
        .navbar-brand .logo {
            font-weight: bold; /* Make logo stand out */
        }
        .nav-links {
            /* margin-left: auto; -- Removed */
            /* margin-right: auto; -- Removed */
            display: flex;
            justify-content: center; /* This centers the <a> links within this div */
        }
        .navbar a {
            /* float: left; -- remove float for flexbox */
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        .navbar a:hover { background-color: #ddd; color: black; }
        .navbar a.active { background-color: #555; } /* Style for active tab link */
        .tabcontent { display: none; padding: 20px; }
        .tabcontent.active { display: block; }
        /* Center content within a tab */
        .tabcontent-centered {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center; /* For inline/text content within items */
        }
        /* Styling for the webhooks list */
        #webhooks-list {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
            width: 80%; /* Or a fixed width, e.g., 600px */
            max-width: 800px;
        }
        #webhooks-list li {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
            text-align: left; /* Align text inside list items to the left */
        }
        #webhooks-list li p {
            margin: 5px 0;
        }
        #webhooks-list li strong {
            display: inline-block;
            width: 120px; /* Fixed width for labels */
        }
        .delete-webhook-btn {
            background-color: #f44336; /* Red */
            color: white;
            border: none;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            float: right; /* Position to the right */
            margin-left: 10px;
        }
        .delete-webhook-btn:hover {
            background-color: #da190b;
        }
        .validate-webhook-btn {
            background-color: #2196F3; /* Blue */
            color: white;
            border: none;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
            margin-left: 10px; /* Keeps it to the left of delete if both are present */
        }
        .validate-webhook-btn:hover {
            background-color: #0b7dda;
        }
        /* Style for code-block like values */
        .code-block-value {
            background-color: #f6f8fa; /* GitHub-like light grey */
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid #eaecef;
            font-size: 0.9em;
            color: #24292e; /* GitHub-like text color for code */
            word-break: break-all; /* Helps with long IDs or URLs */
        }
        /* Ensure link within code-block still looks like a link */
        .code-block-value a {
            color: #0366d6; /* GitHub link blue */
            text-decoration: none;
        }
        .code-block-value a:hover {
            text-decoration: underline;
        }
        /* Added for the spacer */
        .navbar-brand-spacer {
            visibility: hidden;
            display: block;
            color: white; /* Match brand for sizing consistency if needed */
            padding: 14px 16px; /* Match brand */
            font-size: 1.2em; /* Match brand */
            text-decoration: none; /* Match brand */
        }
        .navbar-brand-spacer .logo {
            font-weight: bold; /* Match brand */
        }
        /* Styles for Add Webhook form */
        #add-webhook-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            width: 80%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: stretch; /* Make input and button full width of container */
        }
        #add-webhook-form h3 {
            margin-top: 0;
            text-align: center;
        }
        #add-webhook-form label {
            margin-bottom: 5px;
            font-weight: bold;
            text-align: left;
        }
        #webhook-url-input {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        #add-webhook-btn {
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        #add-webhook-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <span class="logo">ùïè</span> AAA Dashboard
        </div>
        <div class="nav-links">
            <a href="#webhooks" onclick="openTab(event, 'webhooks')">Webhooks</a>
            <a href="#subscriptions" onclick="openTab(event, 'subscriptions')">Subscriptions</a>
            <a href="#live-events" onclick="openTab(event, 'live-events')">Live Events</a>
        </div>
        <div class="navbar-brand-spacer">
            <span class="logo">ùïè</span> AAA Dashboard
        </div>
    </div>

    <div id="webhooks" class="tabcontent active">
        <div class="tabcontent-centered">
            <h2>Webhooks</h2>
            <p>Manage your registered webhook URLs.</p>
            <div id="webhooks-loading" style="display: none;">Loading webhooks...</div>
            <ul id="webhooks-list"></ul>
            <div id="webhooks-error" style="display: none; color: red;"></div>

            <div id="add-webhook-form">
                <h3>Add New Webhook</h3>
                <label for="webhook-url-input">Webhook URL:</label>
                <input type="url" id="webhook-url-input" placeholder="https://your-domain.com/webhook/twitter" required>
                <button id="add-webhook-btn" onclick="handleAddWebhook()">Add Webhook</button>
                <div id="add-webhook-message" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="subscriptions" class="tabcontent">
        <h2>Subscriptions</h2>
        <p>Content for Subscriptions goes here.</p>
    </div>

    <div id="live-events" class="tabcontent">
        <h2>Live Events</h2>
        <p>Content for Live Events goes here.</p>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("navbar")[0].getElementsByTagName("a");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            // Update URL hash without jumping
            if (history.pushState) {
                history.pushState(null, null, '#' + tabName);
            } else {
                location.hash = '#' + tabName;
            }
            // evt.currentTarget.className += " active"; // Add active class to the clicked link
            // Clear active class from all links first
            const currentActiveLinks = document.querySelectorAll('.navbar .nav-links a.active');
            currentActiveLinks.forEach(link => link.classList.remove('active'));
            // Add active class to the clicked link
            evt.currentTarget.classList.add('active');

            // If the webhooks tab is now active, fetch its data
            if (tabName === 'webhooks') {
                fetchWebhooks();
            }
        }

        async function fetchWebhooks() {
            const listElement = document.getElementById('webhooks-list');
            const loadingElement = document.getElementById('webhooks-loading');
            const errorElement = document.getElementById('webhooks-error');

            if (!listElement || !loadingElement || !errorElement) return;

            listElement.innerHTML = ''; // Clear previous results
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            loadingElement.style.display = 'block';

            try {
                const response = await fetch('/api/webhooks');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to parse error response' }));
                    throw new Error(`Error ${response.status}: ${errorData.error || errorData.message || 'Failed to fetch webhooks'}`);
                }
                const result = await response.json();

                if (result.data && result.data.length > 0) {
                    result.data.forEach(webhook => {
                        const listItem = document.createElement('li');
                        const createdAt = new Date(webhook.created_at).toUTCString().replace('GMT', 'UTC');
                        const isValid = webhook.valid ? 'Yes' : 'No';

                        listItem.innerHTML = `
                            <button class="delete-webhook-btn" onclick="confirmDeleteWebhook('${webhook.id}', '${webhook.url}')">Delete</button>
                            <button class="validate-webhook-btn" onclick="handleValidateWebhook(this, '${webhook.id}')">Validate</button>
                            <p><strong>ID:</strong> <span class="code-block-value">${webhook.id}</span></p>
                            <p><strong>URL:</strong> <span class="code-block-value"><a href="${webhook.url}" target="_blank">${webhook.url}</a></span></p>
                            <p><strong>Created At:</strong> <span class="code-block-value">${createdAt}</span></p>
                            <p><strong>Valid:</strong> <span class="code-block-value">${isValid}</span></p>
                        `;
                        listElement.appendChild(listItem);
                    });
                } else if (result.meta && result.meta.result_count === 0) {
                    listElement.innerHTML = '<li>No webhooks registered.</li>';
                } else {
                     listElement.innerHTML = '<li>Could not parse webhook data or no webhooks found.</li>';
                }

            } catch (err) {
                console.error("Failed to fetch or display webhooks:", err);
                errorElement.textContent = err.message || 'An unexpected error occurred.';
                errorElement.style.display = 'block';
                listElement.innerHTML = '<li>Error loading webhooks.</li>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        async function handleAddWebhook() {
            const urlInput = document.getElementById('webhook-url-input');
            const messageElement = document.getElementById('add-webhook-message');
            const errorElement = document.getElementById('webhooks-error'); // Use main error display too

            if (!urlInput || !messageElement || !errorElement) return;

            const webhookUrl = urlInput.value.trim();
            messageElement.textContent = '';
            messageElement.style.color = 'red'; // Default to red for errors
            errorElement.style.display = 'none'; // Hide main error display initially
            errorElement.textContent = '';

            if (!webhookUrl) {
                messageElement.textContent = 'Please enter a webhook URL.';
                return;
            }

            // Basic URL validation (can be more sophisticated)
            try {
                new URL(webhookUrl); // Will throw an error if invalid
            } catch (_) {
                messageElement.textContent = 'Invalid URL format.';
                return;
            }

            messageElement.textContent = 'Adding webhook...';
            messageElement.style.color = 'black';

            try {
                const response = await fetch('/api/webhooks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: webhookUrl }),
                });

                const responseData = await response.json();

                if (response.ok) { // e.g., 201 Created
                    messageElement.textContent = `Webhook created successfully! ID: ${responseData.data?.id || 'N/A'}`;
                    messageElement.style.color = 'green';
                    urlInput.value = ''; // Clear input field
                    fetchWebhooks(); // Refresh the list
                } else {
                    console.log("[DEBUG] AddWebhook Error - Server Response Data:", JSON.parse(JSON.stringify(responseData))); 
                    let detailedErrorMessage = 'Failed to create webhook.'; // Default
                    
                    // The responseData itself is the Twitter error object in this case
                    const twitterError = responseData; 

                    if (typeof twitterError === 'object' && twitterError !== null) {
                        if (twitterError.errors && twitterError.errors.length > 0 && twitterError.errors[0].message) {
                            detailedErrorMessage = twitterError.errors[0].message;
                            console.log("[DEBUG] AddWebhook Error - Extracted from twitterError.errors[0].message");
                        } else if (twitterError.title) {
                            detailedErrorMessage = twitterError.title + (twitterError.detail ? `: ${twitterError.detail}` : '');
                            console.log("[DEBUG] AddWebhook Error - Extracted from twitterError.title/detail");
                        } else if (twitterError.detail) {
                            detailedErrorMessage = twitterError.detail;
                            console.log("[DEBUG] AddWebhook Error - Extracted from twitterError.detail");
                        } else if (twitterError.message) { // Fallback for simpler error objects that just have a message
                            detailedErrorMessage = twitterError.message;
                            console.log("[DEBUG] AddWebhook Error - Extracted from twitterError.message");
                        } else {
                            detailedErrorMessage = JSON.stringify(twitterError);
                            console.log("[DEBUG] AddWebhook Error - Fallback to JSON.stringify(twitterError)");
                        }
                    } else if (typeof twitterError === 'string') { // Should not happen if server sends JSON error
                        detailedErrorMessage = twitterError; 
                        console.log("[DEBUG] AddWebhook Error - twitterError was a string (unexpected for JSON API error)");
                    } else {
                        console.log("[DEBUG] AddWebhook Error - twitterError was not an object or string. Using default.");
                    }
                    const errorMsg = `Error ${response.status}: ${detailedErrorMessage}`;
                    messageElement.textContent = errorMsg;
                }
            } catch (err) {
                console.error("Failed to add webhook:", err);
                const errMsg = `Failed to add webhook: ${err.message}`;
                messageElement.textContent = errMsg;
                // errorElement.textContent = errMsg;
                // errorElement.style.display = 'block';
            }
        }

        async function confirmDeleteWebhook(webhookId, webhookUrl) {
            if (!confirm(`Are you sure you want to delete the webhook for URL: ${webhookUrl} (ID: ${webhookId})?`)) {
                return;
            }

            const errorElement = document.getElementById('webhooks-error');
            errorElement.style.display = 'none';
            errorElement.textContent = '';

            try {
                const response = await fetch(`/api/webhooks/${webhookId}`, {
                    method: 'DELETE',
                });

                if (response.ok) { // status 200-299, includes 204 No Content
                    alert('Webhook deleted successfully!');
                    fetchWebhooks(); // Refresh the list
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to parse server error response for delete operation' }));
                    let finalDetailMessage = 'Failed to delete webhook.'; // Default

                    if (errorData.details) { // errorData.details is from our server, which holds Twitter's error content
                        const twitterError = errorData.details;
                        if (typeof twitterError === 'object' && twitterError !== null) {
                            if (twitterError.errors && twitterError.errors.length > 0 && twitterError.errors[0].message) {
                                finalDetailMessage = twitterError.errors[0].message;
                            } else if (twitterError.title) {
                                finalDetailMessage = twitterError.title + (twitterError.detail ? `: ${twitterError.detail}` : '');
                            } else if (twitterError.detail) {
                                finalDetailMessage = twitterError.detail;
                            } else {
                                finalDetailMessage = JSON.stringify(twitterError); // fallback if structure is unexpected
                            }
                        } else if (typeof twitterError === 'string') {
                            finalDetailMessage = twitterError; // If details was just a string from Twitter
                        }
                    } else if (errorData.error) { // Top-level error string from our server
                        finalDetailMessage = errorData.error;
                    } else if (errorData.message && !errorData.details && !errorData.error) { // Fallback if parsing failed and we got { message: '...' }
                         finalDetailMessage = errorData.message;
                    }
                    throw new Error(`Error ${response.status}: ${finalDetailMessage}`);
                }
            } catch (err) {
                console.error("Failed to delete webhook:", err);
                errorElement.textContent = `Failed to delete: ${err.message}`;
                errorElement.style.display = 'block';
                // Optionally, also alert the error
                alert(`Failed to delete webhook: ${err.message}`);
            }
        }

        async function handleValidateWebhook(buttonElement, webhookId) {
            const originalButtonText = buttonElement.textContent;
            buttonElement.textContent = 'Validating...';
            buttonElement.disabled = true;

            try {
                const response = await fetch(`/api/webhooks/${webhookId}`, {
                    method: 'PUT',
                });

                if (response.status === 204) { 
                    alert(`Validation request sent successfully for webhook ID: ${webhookId}.\nCheck your server logs for CRC activity and refresh the list to see updated status eventually.`);
                } else if (!response.ok) { 
                    const errorData = await response.json().catch(() => ({ message: 'Failed to parse server error response for validation' }));
                    let finalDetailMessage = 'Failed to send validation request.';
                    if (errorData.details) {
                        const twitterError = errorData.details;
                        if (typeof twitterError === 'object' && twitterError !== null) {
                            if (twitterError.errors && twitterError.errors.length > 0 && twitterError.errors[0].message) {
                                finalDetailMessage = twitterError.errors[0].message;
                            } else if (twitterError.title) {
                                finalDetailMessage = twitterError.title + (twitterError.detail ? `: ${twitterError.detail}` : '');
                            } else if (twitterError.detail) {
                                finalDetailMessage = twitterError.detail;
                            } else { finalDetailMessage = JSON.stringify(twitterError); }
                        } else if (typeof twitterError === 'string') { finalDetailMessage = twitterError; }
                    } else if (errorData.error) { finalDetailMessage = errorData.error; }
                     else if (errorData.message) { finalDetailMessage = errorData.message; }
                    
                    alert(`Error ${response.status}: ${finalDetailMessage}`);
                } else {
                    alert(`Unexpected response status ${response.status} while sending validation request.`);
                }
            } catch (err) {
                console.error("Failed to send validation request:", err);
                alert(`Failed to send validation request: ${err.message}`);
            } finally {
                buttonElement.textContent = originalButtonText;
                buttonElement.disabled = false;
            }
        }

        // Open tab based on URL hash on page load
        window.onload = function() {
            let tabToOpen = 'webhooks'; // Default tab
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                const el = document.getElementById(hash);
                if (el && el.classList.contains('tabcontent')) {
                    tabToOpen = hash;
                }
            }
            // Ensure the link itself is marked active and content is shown
            const targetLink = document.querySelector('.navbar .nav-links a[href="#' + tabToOpen + '"]');
            if (targetLink) {
                targetLink.click(); // This will trigger openTab, which in turn calls fetchWebhooks if 'webhooks' is the tab
            } else { // Fallback if hash is invalid
                 document.querySelector('.navbar .nav-links a[href="#webhooks"]').click();
            }
        };
    </script>
</body>
</html> 